<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HamzaSound - Connexion Spotify</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #eee;
      text-align: center;
      padding: 50px;
    }
    button {
      background-color: #1db954;
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 1.2rem;
      border-radius: 30px;
      cursor: pointer;
    }
    #player-status {
      margin-top: 20px;
      font-size: 1rem;
    }
  </style>
</head>
<body>

  <h1>HamzaSound - Écoute Spotify</h1>

  <button id="login-btn">Se connecter avec Spotify</button>

  <div id="player-container" style="display:none;">
    <h2>Lecteur Spotify</h2>
    <div id="player-status">Connexion au player...</div>
    <button id="play-btn">▶️ Play</button>
    <button id="pause-btn">⏸ Pause</button>
  </div>

  <script>
    const clientId = '4d8348fc58e843039f1ce4c19e2518ae';

    // Redirect URI pour GitHub Pages
    const redirectUri = 'https://hamzasound.github.io/HamzaSound/';

    document.getElementById('login-btn').onclick = () => {
      const scopes = [
        'streaming',
        'user-read-email',
        'user-read-private',
        'user-read-playback-state',
        'user-modify-playback-state',
        'user-read-currently-playing'
      ];

      const authUrl = 'https://accounts.spotify.com/authorize' +
        '?response_type=token' +
        '&client_id=' + encodeURIComponent(clientId) +
        '&scope=' + encodeURIComponent(scopes.join(' ')) +
        '&redirect_uri=' + encodeURIComponent(redirectUri) +
        '&show_dialog=true';

      window.location = authUrl;
    };

    function getTokenFromUrl() {
      return window.location.hash
        .substring(1)
        .split('&')
        .reduce((initial, item) => {
          let parts = item.split('=');
          initial[parts[0]] = decodeURIComponent(parts[1]);
          return initial;
        }, {});
    }

    window.onload = () => {
      const hash = getTokenFromUrl();
      window.location.hash = '';

      const token = hash.access_token;
      if (token) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('player-container').style.display = 'block';

        const script = document.createElement('script');
        script.src = 'https://sdk.scdn.co/spotify-player.js';
        document.body.appendChild(script);

        window.onSpotifyWebPlaybackSDKReady = () => {
          const player = new Spotify.Player({
            name: 'HamzaSound Player',
            getOAuthToken: cb => { cb(token); },
            volume: 0.5
          });

          player.addListener('ready', ({ device_id }) => {
            document.getElementById('player-status').textContent = 'Player prêt. Device ID: ' + device_id;

            fetch('https://api.spotify.com/v1/me/player', {
              method: 'PUT',
              body: JSON.stringify({
                device_ids: [device_id],
                play: false
              }),
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              }
            });
          });

          player.addListener('not_ready', ({ device_id }) => {
            document.getElementById('player-status').textContent = 'Player déconnecté';
          });

          player.connect();

          document.getElementById('play-btn').onclick = () => {
            player.resume();
          };
          document.getElementById('pause-btn').onclick = () => {
            player.pause();
          };
        };
      }
    };
  </script>
</body>
</html>
